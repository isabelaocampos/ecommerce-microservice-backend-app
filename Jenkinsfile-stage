pipeline {
    agent any
    
    tools {
        maven 'Maven-3.8.1'
    }
    
    environment {
        JAVA_HOME = '/opt/jdk-11.0.2'
        MAVEN_OPTS = '-Dmaven.test.failure.ignore=true'
        MINIKUBE_IP = sh(script: 'kubectl config view -o jsonpath=\'{.clusters[0].cluster.server}\' | sed \'s|https://||;s|:.*||\'', returnStdout: true).trim()
    }
    
    stages {
        stage('🔧 Configurar Kubernetes') {
            steps {
                echo '⚙️ Configurando acceso a Kubernetes con Service Account Token...'
                sh '''
                    # Limpiar configuración anterior
                    echo "🗑️ Limpiando configuración anterior..."
                    rm -rf ~/.kube/config 2>/dev/null || true
                    mkdir -p ~/.kube
                    
                    # Obtener información del cluster
                    MINIKUBE_IP=$(minikube ip 2>/dev/null || echo "192.168.49.2")
                    K8S_SERVER="https://${MINIKUBE_IP}:8443"
                    
                    echo "📍 Kubernetes API Server: ${K8S_SERVER}"
                    
                    # Crear kubeconfig usando token de service account
                    cat > ~/.kube/config << EOF
apiVersion: v1
kind: Config
clusters:
- cluster:
    insecure-skip-tls-verify: true
    server: ${K8S_SERVER}
  name: minikube
contexts:
- context:
    cluster: minikube
    user: jenkins-sa
    namespace: ecommerce
  name: minikube
current-context: minikube
users:
- name: jenkins-sa
  user:
    token: ${K8S_TOKEN}
EOF
                    
                    chmod 600 ~/.kube/config
                    
                    echo "✅ Kubeconfig creado con token"
                    
                    # Verificar conexión
                    echo "🔌 Verificando conexión al cluster..."
                    kubectl version --client
                    kubectl cluster-info || echo "⚠️ Esperando conexión..."
                    kubectl get nodes || echo "⚠️ Verificando nodos..."
                '''
            }
        }
        
        stage('🔍 Checkout') {
            steps {
                echo '📥 Clonando repositorio...'
                checkout scm
            }
        }
        
        stage('🏗️ Build & Test - Fase 1') {
            parallel {
                stage('user-service') {
                    stages {
                        stage('Build user-service') {
                            steps {
                                echo '🔨 Construyendo user-service...'
                                dir('user-service') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test user-service') {
                            steps {
                                echo '🧪 Ejecutando tests de user-service...'
                                dir('user-service') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build user-service') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de user-service en Minikube...'
                                dir('user-service') {
                                    sh '''
                                        # Construir directamente en Minikube usando minikube image build
                                        minikube image build -t user-service:latest .
                                        minikube image build -t user-service:${BUILD_NUMBER} .
                                        
                                        # Verificar que la imagen existe
                                        minikube image ls | grep user-service || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
                
                stage('product-service') {
                    stages {
                        stage('Build product-service') {
                            steps {
                                echo '🔨 Construyendo product-service...'
                                dir('product-service') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test product-service') {
                            steps {
                                echo '🧪 Ejecutando tests de product-service...'
                                dir('product-service') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build product-service') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de product-service en Minikube...'
                                dir('product-service') {
                                    sh '''
                                        minikube image build -t product-service:latest .
                                        minikube image build -t product-service:${BUILD_NUMBER} .
                                        minikube image ls | grep product-service || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('🏗️ Build & Test - Fase 2') {
            parallel {
                stage('favourite-service') {
                    stages {
                        stage('Build favourite-service') {
                            steps {
                                echo '🔨 Construyendo favourite-service...'
                                dir('favourite-service') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test favourite-service') {
                            steps {
                                echo '🧪 Ejecutando tests de favourite-service...'
                                dir('favourite-service') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build favourite-service') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de favourite-service en Minikube...'
                                dir('favourite-service') {
                                    sh '''
                                        minikube image build -t favourite-service:latest .
                                        minikube image build -t favourite-service:${BUILD_NUMBER} .
                                        minikube image ls | grep favourite-service || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
                
                stage('order-service') {
                    stages {
                        stage('Build order-service') {
                            steps {
                                echo '🔨 Construyendo order-service...'
                                dir('order-service') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test order-service') {
                            steps {
                                echo '🧪 Ejecutando tests de order-service...'
                                dir('order-service') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build order-service') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de order-service en Minikube...'
                                dir('order-service') {
                                    sh '''
                                        minikube image build -t order-service:latest .
                                        minikube image build -t order-service:${BUILD_NUMBER} .
                                        minikube image ls | grep order-service || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('🏗️ Build & Test - Fase 3') {
            parallel {
                stage('payment-service') {
                    stages {
                        stage('Build payment-service') {
                            steps {
                                echo '🔨 Construyendo payment-service...'
                                dir('payment-service') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test payment-service') {
                            steps {
                                echo '🧪 Ejecutando tests de payment-service...'
                                dir('payment-service') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build payment-service') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de payment-service en Minikube...'
                                dir('payment-service') {
                                    sh '''
                                        minikube image build -t payment-service:latest .
                                        minikube image build -t payment-service:${BUILD_NUMBER} .
                                        minikube image ls | grep payment-service || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
                
                stage('shipping-service') {
                    stages {
                        stage('Build shipping-service') {
                            steps {
                                echo '🔨 Construyendo shipping-service...'
                                dir('shipping-service') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test shipping-service') {
                            steps {
                                echo '🧪 Ejecutando tests de shipping-service...'
                                dir('shipping-service') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build shipping-service') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de shipping-service en Minikube...'
                                dir('shipping-service') {
                                    sh '''
                                        minikube image build -t shipping-service:latest .
                                        minikube image build -t shipping-service:${BUILD_NUMBER} .
                                        minikube image ls | grep shipping-service || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('🏗️ Build & Test - Fase 4 (API Gateway & Proxy)') {
            parallel {
                stage('api-gateway') {
                    stages {
                        stage('Build api-gateway') {
                            steps {
                                echo '🔨 Construyendo api-gateway...'
                                dir('api-gateway') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test api-gateway') {
                            steps {
                                echo '🧪 Ejecutando tests de api-gateway...'
                                dir('api-gateway') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build api-gateway') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de api-gateway en Minikube...'
                                dir('api-gateway') {
                                    sh '''
                                        minikube image build -t api-gateway:latest .
                                        minikube image build -t api-gateway:${BUILD_NUMBER} .
                                        minikube image ls | grep api-gateway || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
                
                stage('proxy-client') {
                    stages {
                        stage('Build proxy-client') {
                            steps {
                                echo '🔨 Construyendo proxy-client...'
                                dir('proxy-client') {
                                    sh 'mvn clean package -DskipTests'
                                }
                            }
                        }
                        stage('Test proxy-client') {
                            steps {
                                echo '🧪 Ejecutando tests de proxy-client...'
                                dir('proxy-client') {
                                    sh 'mvn test || true'
                                }
                            }
                        }
                        stage('Docker Build proxy-client') {
                            steps {
                                echo '🐳 Construyendo imagen Docker de proxy-client en Minikube...'
                                dir('proxy-client') {
                                    sh '''
                                        minikube image build -t proxy-client:latest .
                                        minikube image build -t proxy-client:${BUILD_NUMBER} .
                                        minikube image ls | grep proxy-client || echo "Imagen creada"
                                    '''
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('📦 Verificar Artefactos') {
            steps {
                echo '🔍 Verificando JAR files y Docker images...'
                sh '''
                    echo "=== JAR Files Generados ==="
                    find . -name "*.jar" -path "*/target/*" -not -path "*original*" | while read jar; do
                        echo "✅ $jar ($(du -h "$jar" | cut -f1))"
                    done
                    
                    echo ""
                    echo "=== Docker Images en Minikube ==="
                    minikube image ls | grep -E "(user-service|product-service|favourite-service|order-service|payment-service|shipping-service|api-gateway|proxy-client)" || echo "Verificando imágenes..."
                '''
            }
        }
        
        stage('🚀 Deploy to Kubernetes (Stage)') {
            steps {
                echo '☸️ Desplegando microservicios en Kubernetes...'
                sh '''
                    # Ahora kubectl usará el token configurado
                    echo "🔧 Usando kubectl con Service Account Token"
                    
                    # Crear namespace si no existe
                    kubectl get namespace ecommerce || kubectl create namespace ecommerce
                    
                    # Aplicar deployments de microservicios
                    echo "🔌 Desplegando user-service..."
                    minikube kubectl -- apply -f k8s/user-service-deployment.yaml
                    
                    echo "🔌 Desplegando product-service..."
                    minikube kubectl -- apply -f k8s/product-service-deployment.yaml
                    
                    echo "🔌 Desplegando favourite-service..."
                    minikube kubectl -- apply -f k8s/favourite-service-deployment.yaml
                    
                    echo "🔌 Desplegando order-service..."
                    minikube kubectl -- apply -f k8s/order-service-deployment.yaml
                    
                    echo "🔌 Desplegando payment-service..."
                    minikube kubectl -- apply -f k8s/payment-service-deployment.yaml
                    
                    echo "🔌 Desplegando shipping-service..."
                    minikube kubectl -- apply -f k8s/shipping-service-deployment.yaml
                    
                    # Aplicar API Gateway y Proxy
                    echo "🌐 Desplegando api-gateway..."
                    minikube kubectl -- apply -f k8s/api-gateway-deployment.yaml
                    
                    echo "🔀 Desplegando proxy-client..."
                    minikube kubectl -- apply -f k8s/proxy-client-deployment.yaml
                    
                    echo ""
                    echo "✅ Deployments aplicados"
                '''
            }
        }
        
        stage('⏳ Esperar Deployments') {
            steps {
                echo '⏰ Esperando que los pods estén listos...'
                sh '''
                    echo "Esperando user-service..."
                    kubectl wait --for=condition=available --timeout=120s deployment/user-service -n ecommerce || true
                    
                    echo "Esperando product-service..."
                    kubectl wait --for=condition=available --timeout=120s deployment/product-service -n ecommerce || true
                    
                    echo "Esperando favourite-service..."
                    kubectl wait --for=condition=available --timeout=120s deployment/favourite-service -n ecommerce || true
                    
                    echo "Esperando order-service..."
                    kubectl wait --for=condition=available --timeout=120s deployment/order-service -n ecommerce || true
                    
                    echo "Esperando payment-service..."
                    kubectl wait --for=condition=available --timeout=120s deployment/payment-service -n ecommerce || true
                    
                    echo "Esperando shipping-service..."
                    kubectl wait --for=condition=available --timeout=120s deployment/shipping-service -n ecommerce || true
                    
                    echo "Esperando api-gateway..."
                    kubectl wait --for=condition=available --timeout=120s deployment/api-gateway -n ecommerce || true
                    
                    echo "Esperando proxy-client..."
                    kubectl wait --for=condition=available --timeout=120s deployment/proxy-client -n ecommerce || true
                    
                    echo ""
                    echo "Estado de los pods:"
                    kubectl get pods -n ecommerce
                '''
            }
        }
        
        stage('🧪 Integration Tests on K8s') {
            parallel {
                stage('Test user-service en K8s') {
                    steps {
                        echo '🔍 Verificando user-service en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30700"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            # Esperar a que el servicio responda
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ user-service está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando user-service..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test product-service en K8s') {
                    steps {
                        echo '🔍 Verificando product-service en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30500"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ product-service está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando product-service..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test order-service en K8s') {
                    steps {
                        echo '🔍 Verificando order-service en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30300"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ order-service está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando order-service..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test payment-service en K8s') {
                    steps {
                        echo '🔍 Verificando payment-service en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30400"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ payment-service está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando payment-service..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test shipping-service en K8s') {
                    steps {
                        echo '🔍 Verificando shipping-service en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30600"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ shipping-service está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando shipping-service..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test favourite-service en K8s') {
                    steps {
                        echo '🔍 Verificando favourite-service en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30800"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ favourite-service está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando favourite-service..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test api-gateway en K8s') {
                    steps {
                        echo '🔍 Verificando api-gateway en Kubernetes...'
                        sh '''
                            MINIKUBE_IP=$(minikube ip)
                            SERVICE_URL="http://${MINIKUBE_IP}:30100"
                            
                            echo "Testeando: ${SERVICE_URL}/actuator/health"
                            
                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ api-gateway está respondiendo"
                                    curl -s "${SERVICE_URL}/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando api-gateway..."
                                sleep 5
                            done
                        '''
                    }
                }
                
                stage('Test proxy-client en K8s') {
                    steps {
                        echo '🔍 Verificando proxy-client en Kubernetes...'
                        sh '''
                            # Usar port-forward para exponer el service proxy-client localmente en el puerto 30200
                            echo "Creando port-forward de proxy-client svc: 30200 -> 8900"
                            kubectl -n ecommerce port-forward svc/proxy-client 30200:8900 >/tmp/port-forward-proxy-client.log 2>&1 &
                            PF=$!
                            # Dar tiempo para que el port-forward se establezca
                            sleep 2

                            SERVICE_URL="http://127.0.0.1:30200"
                            echo "Testeando: ${SERVICE_URL}/app/actuator/health"

                            for i in {1..30}; do
                                if curl -s -f "${SERVICE_URL}/app/actuator/health" > /dev/null 2>&1; then
                                    echo "✅ proxy-client está respondiendo"
                                    curl -s "${SERVICE_URL}/app/actuator/health" | grep -q "UP" && echo "✅ Health check OK"
                                    break
                                fi
                                echo "Intento $i/30 - Esperando proxy-client..."
                                sleep 5
                            done

                            # Limpiar port-forward
                            kill $PF || true
                        '''
                    }
                }
            }
        }
        
        stage('📊 Estado Final') {
            steps {
                echo '📋 Generando reporte del deployment...'
                sh '''
                    echo "========================================="
                    echo "    REPORTE DE DEPLOYMENT - STAGE"
                    echo "========================================="
                    echo ""
                    
                    echo "📦 Deployments:"
                    minikube kubectl -- get deployments -n ecommerce
                    echo ""
                    
                    echo "🎯 Services:"
                    minikube kubectl -- get services -n ecommerce
                    echo ""
                    
                    echo "🐳 Pods:"
                    minikube kubectl -- get pods -n ecommerce
                    echo ""
                    
                    echo "📡 Endpoints de los servicios:"
                    MINIKUBE_IP=$(minikube ip)
                    echo "  🌐 API Gateway:      http://${MINIKUBE_IP}:30100"
                    echo "  🔀 Proxy-client:     http://127.0.0.1:30200 (port-forward)"
                    echo "  👤 user-service:     http://${MINIKUBE_IP}:30700"
                    echo "  📦 product-service:  http://${MINIKUBE_IP}:30500"
                    echo "  ❤️  favourite-service: http://${MINIKUBE_IP}:30800"
                    echo "  🛒 order-service:    http://${MINIKUBE_IP}:30300"
                    echo "  💳 payment-service:  http://${MINIKUBE_IP}:30400"
                    echo "  🚚 shipping-service: http://${MINIKUBE_IP}:30600"
                    echo ""
                    
                    echo "========================================="
                '''
            }
        }
    }
    
    post {
        success {
            echo '✅ ¡Pipeline completado exitosamente!'
            echo '📋 Todos los microservicios fueron:'
            echo '   ✓ Compilados'
            echo '   ✓ Testeados'
            echo '   ✓ Construidos como Docker images'
            echo '   ✓ Desplegados en Kubernetes'
            echo '   ✓ Verificados con health checks'
        }
        failure {
            echo '❌ Pipeline falló. Revisando estado...'
            sh '''
                echo "Estado de pods en ecommerce namespace:"
                minikube kubectl -- get pods -n ecommerce || true
                
                echo ""
                echo "Logs de pods con problemas:"
                minikube kubectl -- get pods -n ecommerce -o json | jq -r '.items[] | select(.status.phase != "Running") | .metadata.name' | while read pod; do
                    echo "=== Logs de $pod ==="
                    minikube kubectl -- logs $pod -n ecommerce --tail=50 || true
                done
            '''
        }
        always {
            echo '🏁 Pipeline finalizado'
            sh '''
                # Limpiar archivos temporales
                rm -f /tmp/kubectl-env-${BUILD_NUMBER}
                rm -f /tmp/kubeconfig-jenkins-${BUILD_NUMBER}
                rm -f /tmp/kubectl-wrapper-${BUILD_NUMBER}.sh
                rm -f /tmp/kubectl-${BUILD_NUMBER}
            '''
            // Archivar resultados de tests
            junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
        }
    }
}