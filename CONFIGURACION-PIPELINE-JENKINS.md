# Configuraci√≥n de Jenkins para Pipeline de Kubernetes (Stage)

## üéØ Objetivo

Configurar Jenkins para ejecutar el pipeline completo que despliega los 6 microservicios en Kubernetes (ambiente stage).

---

## üìã Pre-requisitos

Antes de comenzar, aseg√∫rate de tener:

- ‚úÖ Jenkins corriendo en Docker (puerto 8081)
- ‚úÖ Minikube instalado y corriendo
- ‚úÖ Maven instalado en Jenkins
- ‚úÖ kubectl instalado en Jenkins
- ‚úÖ Jenkins conectado a Minikube

Si no has completado estos pasos, sigue la gu√≠a `GUIA-CONFIGURACION-JENKINS-K8S.md`.

---

## üöÄ Configuraci√≥n Paso a Paso

### Paso 1: Instalar Docker CLI en Jenkins

Jenkins necesita poder ejecutar comandos Docker para construir las im√°genes:

```powershell
# Instalar Docker CLI en el contenedor de Jenkins
docker exec -u root jenkins bash -c "apt-get update && apt-get install -y docker.io"

# Agregar usuario jenkins al grupo docker
docker exec -u root jenkins bash -c "usermod -aG docker jenkins"

# Reiniciar Jenkins
docker restart jenkins
```

**Verificar:**
```powershell
docker exec jenkins docker --version
```

### Paso 2: Configurar Docker para usar Minikube Daemon

El pipeline necesita construir im√°genes directamente en el daemon de Minikube:

```powershell
# Obtener las variables de entorno de Minikube
minikube docker-env

# Esto mostrar√° algo como:
# $Env:DOCKER_TLS_VERIFY = "1"
# $Env:DOCKER_HOST = "tcp://192.168.49.2:2376"
# $Env:DOCKER_CERT_PATH = "C:\Users\Isabella\.minikube\certs"
# $Env:MINIKUBE_ACTIVE_DOCKERD = "minikube"
```

**Nota:** Esto se configura autom√°ticamente en el Jenkinsfile con:
```groovy
sh 'eval $(minikube docker-env)'
```

### Paso 3: Dar Acceso a Minikube Socket

Jenkins necesita acceder al socket de Docker de Minikube:

```powershell
# Conectar Jenkins a la red de Minikube
docker network connect minikube jenkins

# Verificar conectividad
docker exec jenkins ping -c 1 $(minikube ip)
```

### Paso 4: Configurar Credenciales de Git (Opcional)

Si tu repositorio es privado:

1. En Jenkins, ir a: **Manage Jenkins** > **Manage Credentials**
2. Click en **(global)**
3. Click en **Add Credentials**
4. Configurar:
   - **Kind:** Username with password
   - **Username:** tu-usuario-github
   - **Password:** tu-token-github
   - **ID:** github-credentials
   - **Description:** GitHub Access Token

### Paso 5: Crear el Pipeline

1. **Abrir Jenkins:** http://localhost:8081

2. **Crear nuevo item:**
   - Click en **"New Item"**
   - Nombre: `deploy-microservices-stage`
   - Tipo: **Pipeline**
   - Click **OK**

3. **Configurar General:**
   - ‚úÖ **Description:** "Pipeline para desplegar microservicios en Kubernetes (stage environment)"
   - ‚úÖ **Discard old builds:** Days to keep: 7, Max # of builds: 10

4. **Configurar Build Triggers (Opcional):**
   - ‚úÖ **GitHub hook trigger for GITScm polling** (si quieres trigger autom√°tico)
   - ‚úÖ **Poll SCM:** `H/5 * * * *` (chequear cada 5 minutos)

5. **Configurar Pipeline:**
   - **Definition:** Pipeline script from SCM
   - **SCM:** Git
   - **Repository URL:** `https://github.com/isabelaocampos/ecommerce-microservice-backend-app.git`
   - **Credentials:** (Si es privado, selecciona las credenciales creadas)
   - **Branch Specifier:** `*/master`
   - **Script Path:** `Jenkinsfile-stage`

6. **Click en "Save"**

### Paso 6: Configurar Variables de Entorno en Jenkins (Opcional)

Si quieres sobreescribir algunas variables:

1. En el pipeline, click en **"Configure"**
2. En **Pipeline**, agregar:

```groovy
environment {
    MINIKUBE_IP = sh(script: 'minikube ip', returnStdout: true).trim()
    DOCKER_BUILDKIT = '1'
}
```

### Paso 7: Instalar Plugins Necesarios

Aseg√∫rate de tener estos plugins instalados en Jenkins:

1. **Manage Jenkins** > **Manage Plugins** > **Available**
2. Buscar e instalar:
   - ‚úÖ **Kubernetes Plugin**
   - ‚úÖ **Docker Pipeline**
   - ‚úÖ **Git Plugin**
   - ‚úÖ **Pipeline: Stage View Plugin**
   - ‚úÖ **JUnit Plugin** (para reportes de tests)

3. Click **Install without restart**

---

## üß™ Probar el Pipeline

### Primera Ejecuci√≥n

1. En el pipeline `deploy-microservices-stage`, click en **"Build Now"**

2. Observa el progreso en **"Stage View"**:
   ```
   Checkout ‚Üí Build Fase 1 ‚Üí Build Fase 2 ‚Üí Build Fase 3 
   ‚Üí Verificar ‚Üí Deploy ‚Üí Wait ‚Üí Tests ‚Üí Reporte
   ```

3. Si alg√∫n stage falla, click en el stage y luego en **"Logs"**

### Ver Console Output

1. Click en el n√∫mero del build (ej: **#1**)
2. Click en **"Console Output"**
3. Busca l√≠neas con ‚ùå si hay errores

### Verificar Deployment en Kubernetes

Despu√©s de que el pipeline termine:

```powershell
# Ver deployments
kubectl get deployments -n ecommerce

# Ver pods
kubectl get pods -n ecommerce

# Ver services
kubectl get services -n ecommerce
```

---

## üîß Configuraci√≥n Avanzada

### Configurar Post-build Actions

Edita el Jenkinsfile y agrega notificaciones:

```groovy
post {
    success {
        emailext (
            subject: "‚úÖ Pipeline Exitoso: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: "El deployment fue exitoso. Ver: ${env.BUILD_URL}",
            to: "tu-email@example.com"
        )
    }
    failure {
        emailext (
            subject: "‚ùå Pipeline Fall√≥: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
            body: "El deployment fall√≥. Ver logs: ${env.BUILD_URL}/console",
            to: "tu-email@example.com"
        )
    }
}
```

### Configurar Parallel Build

El Jenkinsfile ya tiene builds paralelos configurados:

```groovy
stage('Build & Test - Fase 1') {
    parallel {
        stage('user-service') { ... }
        stage('product-service') { ... }
    }
}
```

Esto reduce el tiempo de build de ~15 minutos a ~7 minutos.

### Agregar Stage de Aprobaci√≥n Manual

Para producci√≥n, agrega un stage de aprobaci√≥n:

```groovy
stage('Aprobar Deploy a Producci√≥n') {
    steps {
        input message: '¬øDesplegar a producci√≥n?',
              ok: 'Deploy',
              submitter: 'admin'
    }
}
```

### Configurar Webhooks de GitHub

Para trigger autom√°tico en cada push:

1. En GitHub, ir a: **Settings** > **Webhooks** > **Add webhook**
2. **Payload URL:** `http://TU-IP-PUBLICA:8081/github-webhook/`
3. **Content type:** `application/json`
4. **Events:** Just the push event
5. **Active:** ‚úÖ
6. Click **Add webhook**

**Nota:** Jenkins debe ser accesible desde internet.

---

## üìä Monitoreo del Pipeline

### Blue Ocean UI (Opcional)

Para una mejor visualizaci√≥n:

1. **Manage Jenkins** > **Manage Plugins**
2. Instalar **Blue Ocean**
3. Acceder en: http://localhost:8081/blue

### Configurar Build Metrics

1. **Manage Jenkins** > **Configure System**
2. En **Build Metrics**, configurar:
   - Retention policy
   - Build failure analyzer

### Ver Historial de Builds

```powershell
# Desde la l√≠nea de comandos
docker exec jenkins cat /var/jenkins_home/jobs/deploy-microservices-stage/builds/legacyIds
```

---

## üõ†Ô∏è Troubleshooting

### Error: "Cannot connect to Minikube"

**Problema:** Jenkins no puede conectarse a Minikube

**Soluci√≥n:**
```powershell
# Verificar que Jenkins est√© en la red de Minikube
docker network inspect minikube | findstr jenkins

# Si no est√°, conectar
docker network connect minikube jenkins

# Verificar conectividad
docker exec jenkins ping -c 1 $(minikube ip)
```

### Error: "kubectl: command not found"

**Problema:** kubectl no est√° instalado en Jenkins

**Soluci√≥n:**
```powershell
docker exec -u root jenkins bash -c "curl -LO 'https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl' && chmod +x kubectl && mv kubectl /usr/local/bin/"
```

### Error: "mvn: command not found"

**Problema:** Maven no est√° configurado

**Soluci√≥n:**
1. **Manage Jenkins** > **Global Tool Configuration**
2. En **Maven**, verificar que `Maven-3.8.1` est√© configurado
3. MAVEN_HOME: `/opt/apache-maven-3.8.1`

### Error: "Permission denied" en Docker

**Problema:** Jenkins no tiene permisos para Docker

**Soluci√≥n:**
```powershell
docker exec -u root jenkins bash -c "usermod -aG docker jenkins"
docker restart jenkins
```

### Pipeline se queda esperando en "Wait for Deployment"

**Problema:** Los pods tardan mucho en estar listos

**Soluci√≥n:**
1. Verificar recursos de Minikube:
   ```powershell
   minikube config set memory 4096
   minikube config set cpus 2
   minikube delete
   minikube start
   ```

2. Ver logs de los pods:
   ```powershell
   kubectl get pods -n ecommerce
   kubectl logs <pod-name> -n ecommerce
   ```

### Error: "ImagePullBackOff"

**Problema:** Kubernetes no encuentra la imagen Docker

**Soluci√≥n:**
```powershell
# Asegurarse de que la imagen est√© en Minikube
& minikube -p minikube docker-env --shell powershell | Invoke-Expression
docker images | findstr user-service

# Si no est√°, construirla manualmente
cd user-service
docker build -t user-service:latest .
```

---

## ‚úÖ Checklist de Configuraci√≥n

Antes de ejecutar el pipeline, verifica:

- [ ] Jenkins corriendo en puerto 8081
- [ ] Minikube corriendo (`minikube status`)
- [ ] kubectl instalado en Jenkins (`docker exec jenkins kubectl version`)
- [ ] Maven configurado en Jenkins (Global Tool Configuration)
- [ ] Docker CLI instalado en Jenkins (`docker exec jenkins docker --version`)
- [ ] Jenkins conectado a red de Minikube
- [ ] Certificados de Minikube copiados a Jenkins
- [ ] Pipeline creado en Jenkins
- [ ] Script Path apunta a `Jenkinsfile-stage`
- [ ] Git repository configurado correctamente

---

## üìö Comandos √ötiles

### Jenkins

```powershell
# Ver logs de Jenkins
docker logs -f jenkins

# Reiniciar Jenkins
docker restart jenkins

# Entrar al contenedor de Jenkins
docker exec -it jenkins bash

# Ver configuraci√≥n de Jenkins
docker exec jenkins cat /var/jenkins_home/config.xml
```

### Kubernetes

```powershell
# Ver todos los recursos
kubectl get all -n ecommerce

# Eliminar namespace completo
kubectl delete namespace ecommerce

# Ver configuraci√≥n de kubectl
docker exec jenkins cat /var/jenkins_home/.kube/config
```

### Minikube

```powershell
# Ver status
minikube status

# Ver IP
minikube ip

# SSH a Minikube
minikube ssh

# Ver Docker daemon
minikube docker-env
```

---

## üéì Siguiente Paso

Una vez que el pipeline est√© configurado y funcionando:

1. **Ejecuta el pipeline:** Build Now
2. **Verifica el deployment:** `kubectl get pods -n ecommerce`
3. **Ejecuta las pruebas:** `.\test-microservices-k8s.ps1`
4. **Revisa la documentaci√≥n:** `PIPELINE-STAGE-K8S.md`

---

**¬°Tu pipeline de CI/CD est√° listo para automatizar deployments a Kubernetes!** üöÄ

---

**Isabella Ocampo**  
Octubre 26, 2025
